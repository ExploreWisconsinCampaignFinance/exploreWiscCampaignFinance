{% load staticfiles %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.12/d3.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <style>
	    body{
			font-family:sans-serif;
	    }
	    .axis path, line{
			stroke:black;
	    }
	    .timeseries path{
			stroke-width:3px;
	    }
	    .timeseries circle{
			stroke: white;
	    }
	    .timeseries text{
			fill: white;
			stroke: none;
			font-size:12px;
			font-weight: bold;
	    }
	    .line {
			float:left;
	    }
	    .line_container{
			width: 150px;
			height: 20px;
	    }
	    path{
			fill: none;
	    }
	    .key{
			float:right;
	    }
	    .key_line{
			font-size:15px;
			width:100%;
	    }
	    .key_square{
			height:10px;
			width:10px;
			outline:solid 1px black;
			float:left;
			margin-right:10px;
			margin-top:6px;
			margin-left:10px;
	    }
	    #timeseries{
			float:left;
	    }
	    .tick{
	    	font-size:14px;
	    }
	    
	    .Republican {
			stroke:#cb181d;
			fill:#cb181d;
			background-color:#cb181d;
		}
		.Democrat {
			stroke:#2171b5;
			fill:#2171b5;
			background-color:#2171b5;
		}
		.Libertarian {
			stroke:#ff7f00;
			fill:#ff7f00;
			background-color:#ff7f00;
		}
		.Independent {
			stroke:#a65628;
			fill:#a65628;
			background-color:#a65628;
		}
		.WisconsinPirate {
			stroke:#756bb1;
			fill:#756bb1;
			background-color:#756bb1;
		}
		
    </style>
    <link rel="stylesheet" type="text/css" href="{% static 'css/colours.css' %}" />
    <script>
    
		
		
    </script>
</head>
<body>
    <div id="timeseries"></div>
    <div id="key"></div>
    
    <script>

        //d3.json("{% url "legend_data" %}", draw);
    </script>
    <div style="border: black; font-size:12px; width:400px">
    	
    <p>
		<input type="radio" name="house" id="house_asm" value="Assembly" checked> Assembly <br>
		<input type="radio" name="house" id="house_sen" value="Senate"> Senate
    </p>
	Select year: <select id="sel_year">
	</select> <br>
	
	Select district number <select id="sel_district">
		<option>Select a District</option>
	</select>
    </div>
</body>
</html>

<script src="{% static 'js/graph_setup_and_functions.js' %}">
</script>

<script>
	
	

	var cand_data;
	var house = "Assembly";
	var year = "2014";
	
	$("#house_asm").change(function() {
		check_house();
	});
	$("#house_sen").change(function() {
		check_house();
	});
	
	var check_house = function(){
		if ($("#house_sen").is(':checked')){
			house = "Senate";
			//1099 to look for all records and pull years
			//$.getJSON("{% url 'candidate_data' 'Senate' '1099' %}", function(json) {
			{% url 'candidate_data' 'Senate' '1099' as grabYearURL %}
		} else {
			house = "Assembly";
			{% url 'candidate_data' 'Assembly' '1099' as grabYearURL %}
		}
		
		$.getJSON("{{ grabYearURL }}", function(json) {
			var p_opts = '<option>';
			var s_opts = '</option>';
			var years = p_opts + "Select a year" + s_opts;
			$.each(json, function (i, fb) {
				var year_opt = p_opts + fb.year_ran.substring(0, 4) + s_opts;
				if (years.indexOf(year_opt) < 0){ years += year_opt; }
			});
			$("#sel_year").html(years);
		});		
		console.log("House now equals: " + house);
		
	}
	check_house();
	$("#sel_year").change(function() {
		

		
		year = $(this).val();
		if (year == "Select a year") {return null}
		
		//var tstdates = [];
		$.getJSON("{% static 'js/year_ranges.json' %}", function(data){
			$.each(data, function(i, fb) {
		//		tstdates.push(fb);
				if (year == i){
					console.log("its this one");
					console.log(fb["Begin"]);
					console.log(fb["End"]);					
					rescaleTime(fb["Begin"],fb["End"])
				};

				//console.log(i);
			});
		});
		//console.log(tstdates);
		
		
		var theurl = "/candidate_data/" + house + "/" + year;
		console.log("gonna hit: " + theurl);
	
		var ajaxOpts = {
			async: false,
			dataType: "json",
			success: function(data) { 
				cand_data = data;
				var p_opts = '<option>';
				var s_opts = '</option>';
				var dists = p_opts + "Select a District" + s_opts;
				$.each(data, function (i, fb) {
					var dist_opt = p_opts + fb.district + s_opts;
					if (dists.indexOf(dist_opt) < 0){ dists += dist_opt; }
				});
				$("#sel_district").html(dists);	
			}
		};

		$.ajax(theurl, ajaxOpts);
		
	});
	
	//var grabDistricts(yr)
	
	//this function should be fired on selection of year.
	//With the years being populated when the house radio button is changed.
	//$.getJSON("{% url 'candidate_data' 'Assembly' '2014' %}", function(json) {
	
	//	cand_data = json;
	//	var p_opts = '<option>';
	//	var s_opts = '</option>';
	//	//var years = "";
	//	var dists = p_opts + "Select a District" + s_opts;
	//	$.each(json, function (i, fb) {
	//		var dist_opt = p_opts + fb.district + s_opts;
	//		//var year_opt = p_opts + fb.year_ran.substring(0, 4) + s_opts;
	//		if (dists.indexOf(dist_opt) < 0){ dists += dist_opt; }
	//		//if (years.indexOf(year_opt) < 0){ years += year_opt; }
	//	});
	//	$("#sel_district").html(dists);
	//	//$("#sel_year").html(years);

	//})

	$("#sel_district").change(function() {
		var cont_data = [];
		var maxVal = 0;
		if ($(this).val() == "Select a District") {return }
		//Remember to remove the previous graph		
		$('.timeseries.drawnTimeSeries').remove();
		$('.key_line').remove();
		
		var distNum = $(this).val();
		//constructing the data for the legend
		var leg_data = [];
		
		//Go through each candidate who ran
		//	searching for the matching district 
		$.each(cand_data, function(i, fb) {
			if (fb.district != distNum){
				return;
			}
			console.log(fb.candidate)
			if (fb.candidate == "None, None"){ 
				return; 
			}
			//Collect campaign data for who won, party, etc
			var splt = fb.candidate.split(",");
			var obj = {};
			//Break into key name and display name
			obj["line_id"] = fb.candidate;
			obj["line_name"] = splt[splt.length-1] + " " + splt[0];
			obj["party"] = fb.party.replace(" ", "");
			obj["won"] = fb.won;
			leg_data.push(obj);
		})
		//Collect contributor data from url and store it
		for (var i=0; i<leg_data.length; i++){
			var cand_name = leg_data[i].line_id
			var theurl = "/contributor_data/" + cand_name + "/" + year;
			console.log("The url for contribu data: " + theurl);
			var jsonOutData;
			
			var ajaxOpts = {
				async: false,
				dataType: "json",
				success: function(data) { jsonOutData = data; }
			};
			
			$.ajax(theurl, ajaxOpts);
			
			cont_data.push(jsonOutData)
		}
		console.log("Max val is " + findMaxVal(cont_data));

		rescale(findMaxVal(cont_data))
		for (var i=0; i<leg_data.length; i++){
		
			draw_timeseries(cont_data[i], 'drawnTimeSeries', leg_data[i].party)
		
		}
		// drawing the key
		
		var key_items = d3.select('#key')
		  .selectAll('div')
		  .data(leg_data)
		  .enter()
		  .append('div')
			.attr('class','key_line')
			.attr('id',function(d){return d.line_id+"_key"})

		key_items.append('div')
			.attr('id', function(d){return 'key_square_' + d.line_id})
			.attr('class', function(d){return 'key_square ' + d.line_id + " " + d.party})

		key_items.append('div')
			.attr('class','key_label')
			.text(function(d){
				if (d.won == 1){
					return d.line_name + "*"
				} else {
					return d.line_name
				}
			})
	

	})
	


</script>




